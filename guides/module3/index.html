<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëª¨ë“ˆ 3: ê°€ìƒí™”(Virtualization) íŠ¸ë¦¬ ë·°</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    h1 {
      color: #333;
      margin-bottom: 20px;
    }
    
    .container {
      display: flex;
      gap: 20px;
    }
    
    .tree-container {
      width: 350px;
      flex-shrink: 0;
      background: white;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      overflow: hidden;
      border-radius: 4px;
    }
    
    .controls {
      margin-bottom: 10px;
      padding: 10px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    
    .stats {
      font-family: monospace;
      margin-top: 20px;
      padding: 10px;
      background: #333;
      color: #fff;
      border-radius: 4px;
      overflow: auto;
    }
    
    button {
      padding: 6px 12px;
      background: #4285f4;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 5px;
    }
    
    button:hover {
      background: #3b78e7;
    }
    
    label {
      margin-right: 10px;
    }
    
    input[type="number"] {
      width: 60px;
      padding: 4px;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <h1>ğŸŒ³ ê°€ìƒí™”ëœ íŒŒì¼ íŠ¸ë¦¬ ë·°</h1>
  
  <div class="controls">
    <label>
      í•­ëª© ìˆ˜:
      <input type="number" id="nodeCount" value="5000" min="100" max="50000">
    </label>
    
    <label>
      ê¹Šì´:
      <input type="number" id="depth" value="5" min="1" max="10">
    </label>
    
    <button id="generateData">ë°ì´í„° ìƒì„±</button>
    <button id="expandAll">ëª¨ë‘ í¼ì¹˜ê¸°</button>
    <button id="collapseAll">ëª¨ë‘ ì ‘ê¸°</button>
  </div>
  
  <div class="container">
    <div class="tree-container" id="treeContainer">
      <!-- íŠ¸ë¦¬ ë·°ê°€ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
    </div>
    
    <div class="stats" id="stats">
      <!-- ì„±ëŠ¥ í†µê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
    </div>
  </div>
  
  <div class="loading-indicator" id="loading">ìƒì„± ì¤‘...</div>
  
  <!-- ëª¨ë“ˆ 2 ì½”ë“œ (ì˜ì¡´ì„±) -->
  <script src="../module2/EventEmitter.js"></script>
  
  <!-- ëª¨ë“ˆ 3 ì½”ë“œ -->
  <script src="NodePool.js"></script>
  <script src="ScrollOptimizations.js"></script>
  <script src="LargeDataGenerator.js"></script>
  <script src="VirtualTreeView.js"></script>
  
  <script>
    // DOM ìš”ì†Œ
    const treeContainer = document.getElementById('treeContainer');
    const statsEl = document.getElementById('stats');
    const loadingEl = document.getElementById('loading');
    const nodeCountInput = document.getElementById('nodeCount');
    const depthInput = document.getElementById('depth');
    const generateBtn = document.getElementById('generateData');
    const expandAllBtn = document.getElementById('expandAll');
    const collapseAllBtn = document.getElementById('collapseAll');
    
    // ê°€ìƒ íŠ¸ë¦¬ ë·° ì¸ìŠ¤í„´ìŠ¤
    let virtualTreeView = null;
    
    // ì„±ëŠ¥ ì¸¡ì • ìœ í‹¸ë¦¬í‹°
    const perf = {
      start(label) {
        if (!this.timers) this.timers = {};
        this.timers[label] = performance.now();
      },
      
      end(label) {
        if (!this.timers || !this.timers[label]) return 0;
        
        const elapsed = performance.now() - this.timers[label];
        delete this.timers[label];
        return elapsed.toFixed(2);
      },
      
      measure(label, fn) {
        this.start(label);
        const result = fn();
        const time = this.end(label);
        return { result, time };
      }
    };
    
    // í†µê³„ ì—…ë°ì´íŠ¸
    function updateStats(stats) {
      statsEl.innerHTML = `
        <h3>ğŸ“Š ì„±ëŠ¥ í†µê³„</h3>
        <pre>${JSON.stringify(stats, null, 2)}</pre>
      `;
    }
    
    // ë°ì´í„° ìƒì„± ë° íŠ¸ë¦¬ ë·° ì´ˆê¸°í™”
    function initializeTree() {
      // ë¡œë”© ì¸ë””ì¼€ì´í„° í‘œì‹œ
      loadingEl.classList.add('visible');
      
      // ë¹„ë™ê¸°ë¡œ ë°ì´í„° ìƒì„± (UI ì°¨ë‹¨ ë°©ì§€)
      setTimeout(() => {
        try {
          const nodeCount = parseInt(nodeCountInput.value, 10);
          const depth = parseInt(depthInput.value, 10);
          
          // íŒŒë¼ë¯¸í„° ì¡°ì • - íŠ¸ë¦¬ ì‚¬ì´ì¦ˆ ì˜ˆì¸¡
          const filesPerFolder = Math.max(2, Math.min(20, Math.ceil(nodeCount / (Math.pow(5, depth) - 1) * 3)));
          const foldersPerFolder = Math.max(1, Math.min(5, Math.ceil(Math.pow(nodeCount, 1/depth) / 2)));
          
          // ì„±ëŠ¥ ì¸¡ì • ì‹œì‘
          perf.start('total');
          
          // ëŒ€ìš©ëŸ‰ ë°ì´í„° ìƒì„±
          const { result: treeData, time: genTime } = perf.measure('generate', () => 
            LargeDataGenerator.generateLargeFileSystem(depth, filesPerFolder, foldersPerFolder, nodeCount)
          );
          
          // ê¸°ì¡´ íŠ¸ë¦¬ ë·° ì œê±°
          if (virtualTreeView) {
            treeContainer.innerHTML = '';
          }
          
          // ìƒˆ íŠ¸ë¦¬ ë·° ì´ˆê¸°í™”
          const { result: treeView, time: initTime } = perf.measure('initialize', () => 
            new VirtualTreeView(treeContainer, treeData)
          );
          
          virtualTreeView = treeView;
          
          // ì´ ì‹œê°„ ê³„ì‚°
          const totalTime = perf.end('total');
          
          // í’€ ìƒíƒœ ê°€ì ¸ì˜¤ê¸°
          const poolStats = virtualTreeView.nodePool.getStats();
          
          // í†µê³„ ì—…ë°ì´íŠ¸
          updateStats({
            nodes: {
              total: countNodes(treeData),
              visible: virtualTreeView.visibleData.length,
              rendered: poolStats.active
            },
            timing: {
              generation: `${genTime} ms`,
              initialization: `${initTime} ms`,
              total: `${totalTime} ms`
            },
            memory: {
              pool: poolStats
            }
          });
          
          // íŠ¸ë¦¬ ë·°ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
          virtualTreeView.on('node:expand-toggle', () => {
            // ë…¸ë“œ í’€ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateStats({
              nodes: {
                total: countNodes(treeData),
                visible: virtualTreeView.visibleData.length,
                rendered: virtualTreeView.nodePool.getStats().active
              },
              pool: virtualTreeView.nodePool.getStats()
            });
          });
          
        } catch (error) {
          console.error('íŠ¸ë¦¬ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
          statsEl.innerHTML = `<div style="color: red">ì˜¤ë¥˜: ${error.message}</div>`;
        } finally {
          // ë¡œë”© ì¸ë””ì¼€ì´í„° ìˆ¨ê¸°ê¸°
          loadingEl.classList.remove('visible');
        }
      }, 10);
    }
    
    // íŠ¸ë¦¬ì˜ ì´ ë…¸ë“œ ìˆ˜ ê³„ì‚°
    function countNodes(nodes) {
      let count = 0;
      
      function traverse(nodeArray) {
        count += nodeArray.length;
        
        for (const node of nodeArray) {
          if (node.type === 'folder' && node.children) {
            traverse(node.children);
          }
        }
      }
      
      traverse(nodes);
      return count;
    }
    
    // ëª¨ë“  í´ë” í¼ì¹˜ê¸°/ì ‘ê¸°
    function toggleAllFolders(expand) {
      if (!virtualTreeView) return;
      
      virtualTreeView.flattenedData.forEach(node => {
        if (node.type === 'folder') {
          if (expand) {
            virtualTreeView.expandedNodes.add(node.id);
          } else {
            virtualTreeView.expandedNodes.delete(node.id);
          }
        }
      });
      
      // ë³´ì´ëŠ” ë…¸ë“œ ì—…ë°ì´íŠ¸
      virtualTreeView.updateVisibleData();
      virtualTreeView.updateHeightContainer();
      virtualTreeView.render();
    }
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    generateBtn.addEventListener('click', initializeTree);
    expandAllBtn.addEventListener('click', () => toggleAllFolders(true));
    collapseAllBtn.addEventListener('click', () => toggleAllFolders(false));
    
    // ì´ˆê¸° íŠ¸ë¦¬ ìƒì„±
    document.addEventListener('DOMContentLoaded', initializeTree);
  </script>
</body>
</html>
